<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI QGen</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 700px;
        margin: auto;
      }
      label { display: block; margin-top: 15px; }
      select, input { padding: 6px; width: 100%; }
      button {
        margin-top: 20px;
        padding: 10px 20px;
        cursor: pointer;
      }
      #chapter-container { display: block; }
    </style>
  </head>

  <body>
    <h2>AI Question Generator</h2>

  <!-- Subject -->
  <label>
    Subject
    <select id="subject">
      <option value="Math">Math</option>
      <option value="Physics">Physics</option>
      <option value="Chemistry">Chemistry</option>
    </select>
  </label>

    <!-- CURRICULUM -->
    <label>
      Curriculum
      <select id="curriculum">
        <option value="GCSE" selected>GCSE</option>
        <option value="ALEVEL">A-Level</option>
      </select>
    </label>

    <!-- CHAPTER (GCSE Only) -->
    <div id="chapter-container">
      <label>
        Chapter Number
        <select id="chapter">
          <option value="1">Chapter 1</option>
          <option value="2">Chapter 2</option>
          <option value="3">Chapter 3</option>
          <option value="4">Chapter 4</option>
          <option value="5">Chapter 5</option>
        </select>
      </label>
    </div>

    <!-- TOPIC -->
    <label>
    Topic
    <select id="topic">
      <option value="">-- select chapter first --</option>
    </select>
    </label> 

    <!-- DIFFICULTY -->
    <label>
      Difficulty
      <select id="difficulty">
        <option value="Easy">Easy</option>
        <option value="Medium" selected>Medium</option>
        <option value="Hard">Hard</option>
      </select>
    </label>

    <!-- NUMBER OF QUESTIONS -->
    <label>
      Number of questions (1â€“40)
      <input id="num" type="number" value="5" min="1" max="40">
    </label>

    <button id="btn">Generate</button>

    <h2>Result</h2>
    <div id="resultArea">
      <pre id="result"></pre>
    </div>

  <script>
  (function() {
    // DOM references
    const subjectSelect = document.getElementById('subject');
    const curriculum = document.getElementById('curriculum');
    const chapterBox = document.getElementById('chapter-container');
    const chapterSelect = document.getElementById('chapter');
    const topicSelect = document.getElementById('topic');
    const btn = document.getElementById('btn');
    const resultArea = document.getElementById('resultArea');

    const defaultGcseChapters = [
      { value: "1", text: "Chapter 1" },
      { value: "2", text: "Chapter 2" },
      { value: "3", text: "Chapter 3" },
      { value: "4", text: "Chapter 4" },
      { value: "5", text: "Chapter 5" }
    ];

    // Safe fetch helper with timeout
    async function fetchWithTimeout(url, opts = {}, timeout = 8000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      opts.signal = controller.signal;
      try {
        const res = await fetch(url, opts);
        clearTimeout(id);
        return res;
      } catch (err) {
        clearTimeout(id);
        throw err;
      }
    }

    function resetTopicDropdown() {
      if (!topicSelect) return;
      topicSelect.innerHTML = '<option value="">-- select chapter first --</option>';
    }

    // Set chapter label text helper
    const chapterLabelElem = document.querySelector('#chapter-container label');
    function setChapterLabelText(text) {
      if (!chapterLabelElem) return;
      const first = chapterLabelElem.childNodes[0];
      if (first && first.nodeType === Node.TEXT_NODE) {
        first.nodeValue = text + " ";
      } else {
        chapterLabelElem.insertBefore(document.createTextNode(text + " "), chapterLabelElem.firstChild);
      }
    }

    /* ---------- Math handlers ---------- */
    async function populateTopicsGCSE(chapterNum) {
      if (!topicSelect) return;
      topicSelect.innerHTML = '<option value="">Loading...</option>';
      try {
        const res = await fetchWithTimeout(`/math_topics?curriculum=GCSE&chapter_num=${encodeURIComponent(chapterNum)}`, {}, 6000);
        if (!res.ok) { topicSelect.innerHTML = '<option value="">(no topics)</option>'; return; }
        const payload = await res.json();
        const topics = payload.topics || [];
        const seen = new Set(); const clean = [];
        for (let t of topics) {
          if (t === null || typeof t === 'undefined') continue;
          t = String(t).trim(); if (!t) continue; if (t.toLowerCase() === 'nan') continue;
          if (seen.has(t)) continue; seen.add(t); clean.push(t);
        }
        if (clean.length === 0) { topicSelect.innerHTML = '<option value="">(no topics)</option>'; return; }
        let html = '<option value="">-- choose topic --</option>';
        for (const t of clean) html += `<option value="${t.replace(/"/g,'&quot;')}">${t}</option>`;
        topicSelect.innerHTML = html;
      } catch (err) {
        console.error("populateTopicsGCSE failed:", err);
        topicSelect.innerHTML = '<option value="">Error loading topics</option>';
      }
    }

        /* -----------------------
      A-Level topic loader
      endpoint: /topics?curriculum=ALEVEL&chapter_name=Name
      -----------------------*/
    async function populateTopicsALEVEL(chapterName) {
      if (!topicSelect) return;
      topicSelect.innerHTML = '<option value="">Loading...</option>';
      try {
        const res = await fetchWithTimeout(`/math_topics?curriculum=ALEVEL&chapter_name=${encodeURIComponent(chapterName)}`, {}, 6000);
        if (!res.ok) {
          console.error("A-Level topic endpoint error:", res.status);
          topicSelect.innerHTML = '<option value="">(no topics)</option>';
          return;
        }
        const payload = await res.json();
        const topics = payload.topics || [];
        if (topics.length === 0) {
          topicSelect.innerHTML = '<option value="">(no topics)</option>';
          return;
        }
        let html = '<option value="">-- choose topic --</option>';
        for (const t of topics) {
          const safeVal = String(t).replace(/"/g, '&quot;');
          html += `<option value="${safeVal}">${t}</option>`;
        }
        topicSelect.innerHTML = html;
      } catch (err) {
        console.error("populateTopicsALEVEL failed:", err);
        topicSelect.innerHTML = '<option value="">Error loading topics</option>';
      }
    }

    function populateGcseChapters() {
      if (!chapterSelect) return;

      // reset topics and any question_type UI
      resetTopicDropdown();
      const oldQt = document.getElementById('question_type');
      if (oldQt) oldQt.closest('label')?.remove();

      // restore numeric list
      let html = '';
      for (const item of defaultGcseChapters) {
        html += `<option value="${item.value}">${item.text}</option>`;
      }
      chapterSelect.innerHTML = html;
      setChapterLabelText('Chapter Number');

      chapterSelect.onchange = (ev) => {
        const ch = parseInt(ev.target.value || '1', 10);
        // clear topics then load for GCSE
        resetTopicDropdown();
        if (!isNaN(ch)) populateTopicsGCSE(ch);
      };

      // load topics for currently selected chapter
      const selected = parseInt(chapterSelect.value || defaultGcseChapters[0].value, 10);
      resetTopicDropdown();
      if (!isNaN(selected)) populateTopicsGCSE(selected);
    }

    async function populateAlevelChapters() {
      if (!chapterSelect) return;

      // clear prior UI
      resetTopicDropdown();
      const oldQt = document.getElementById('question_type');
      if (oldQt) oldQt.closest('label')?.remove();

      chapterSelect.innerHTML = '<option value="">Loading...</option>';
      try {
        const res = await fetchWithTimeout('/math_topics?curriculum=ALEVEL', {}, 6000);
        if (!res.ok) { chapterSelect.innerHTML = '<option value="">(failed to load)</option>'; return; }
        const data = await res.json();
        const chapters = data.chapters || [];
        if (chapters.length === 0) { chapterSelect.innerHTML = '<option value="">(no chapters)</option>'; return; }

        let html = '<option value="">-- choose chapter --</option>';
        for (const name of chapters) html += `<option value="${name.replace(/"/g,'&quot;')}">${name}</option>`;
        chapterSelect.innerHTML = html;
        setChapterLabelText('Chapter Name');

        chapterSelect.onchange = (e) => {
          const chapterName = e.target.value;
          resetTopicDropdown();
          if (chapterName) populateTopicsALEVEL(chapterName);
        };

        // set first chapter and explicitly call the loader
        chapterSelect.value = chapters[0];
        resetTopicDropdown();
        if (chapters[0]) populateTopicsALEVEL(chapters[0]);

      } catch (err) {
        console.error('populateAlevelChaptersFromJson error:', err);
        chapterSelect.innerHTML = '<option value="">(error)</option>';
      }
    }

    async function populateScienceChapters(subject) {
      if (!chapterSelect) return;

      // reset
      resetTopicDropdown();
      const oldQt = document.getElementById('question_type');
      if (oldQt) oldQt.closest('label')?.remove();

      chapterSelect.innerHTML = '<option value="">Loading...</option>';
      try {
        const res = await fetchWithTimeout(`/science_chapters?subject=${encodeURIComponent(subject)}&curriculum=GCSE`, {}, 6000);
        if (!res.ok) { chapterSelect.innerHTML = '<option value="">(failed)</option>'; return; }
        const data = await res.json();
        const chapters = data.chapters || [];
        if (!chapters.length) { chapterSelect.innerHTML = '<option value="">(no chapters)</option>'; return; }

        let html = '<option value="">-- choose chapter --</option>';
        for (const ch of chapters) html += `<option value="${ch.replace(/"/g,'&quot;')}">${ch}</option>`;
        chapterSelect.innerHTML = html;
        setChapterLabelText('Chapter Name');

        chapterSelect.onchange = (ev) => {
          const ch = ev.target.value;
          resetTopicDropdown();
          if (!ch) return;
          populateScienceTopics(subject, ch);
        };

        // select first chapter and explicitly load topics
        chapterSelect.value = chapters[0];
        resetTopicDropdown();
        if (chapters[0]) populateScienceTopics(subject, chapters[0]);

      } catch (err) {
        console.error("populateScienceChapters failed:", err);
        chapterSelect.innerHTML = '<option value="">(error)</option>';
      }
    }

    async function populateScienceTopics(subject, chapterName) {
      topicSelect.innerHTML = '<option value="">Loading...</option>';
      try {
        const res = await fetchWithTimeout(`/science_topics?subject=${encodeURIComponent(subject)}&curriculum=GCSE&chapter=${encodeURIComponent(chapterName)}`, {}, 6000);
        if (!res.ok) { topicSelect.innerHTML = '<option value="">(no topics)</option>'; return; }
        const data = await res.json();
        const topics = data.topics || [];
        const qtypes = data.question_types || [];

        // Topics
        if (!topics.length) topicSelect.innerHTML = '<option value="">(no topics)</option>';
        else {
          let html = '<option value="">-- choose topic --</option>';
          for (const t of topics) html += `<option value="${t.replace(/"/g,'&quot;')}">${t}</option>`;
          topicSelect.innerHTML = html;
        }

        // Question types
        const oldQt = document.getElementById('question_type');
        if (oldQt) oldQt.closest('label')?.remove();
        if (qtypes.length) {
          const label = document.createElement('label');
          label.innerText = 'Question Type';
          const select = document.createElement('select');
          select.id = 'question_type';
          let qtHtml = '<option value="">-- choose question type --</option>';
          for (const qt of qtypes) qtHtml += `<option value="${qt}">${qt}</option>`;
          select.innerHTML = qtHtml;
          label.appendChild(select);
          topicSelect.parentNode.insertAdjacentElement('afterend', label);
        }

      } catch (err) {
        console.error("populateScienceTopics failed:", err);
        topicSelect.innerHTML = '<option value="">Error loading topics</option>';
      }
    }

    /* ---------- Central UI handler ---------- */
    async function applyUiForSelection() {
      resetTopicDropdown();
      const oldQt = document.getElementById('question_type');
      if (oldQt) oldQt.closest('label')?.remove();

      const subj = subjectSelect?.value || 'Math';
      const curr = curriculum?.value || 'GCSE';
      chapterBox.style.display = 'block';

      if (subj === 'Math') {
        if (curr === 'GCSE') populateGcseChapters();
        else await populateAlevelChapters();
        return;
      }

      if (subj === 'Physics' || subj === 'Chemistry') {
        if (curr === 'GCSE') await populateScienceChapters(subj);
        else {
          chapterSelect.innerHTML = '<option value="">(A-Level coming soon)</option>';
          setChapterLabelText('Chapter Name');
          resetTopicDropdown();
        }
        return;
      }

      // Fallback
      await populateGcseChapters();
    }

    curriculum.addEventListener('change', applyUiForSelection);
    subjectSelect.addEventListener('change', applyUiForSelection);

    (function init() { resetTopicDropdown(); applyUiForSelection(); })();

    /* ---------- Generate button ---------- */
    btn.addEventListener('click', async () => {
      const subj = subjectSelect.value;
      const curr = curriculum.value;
      const topic = topicSelect?.value || "";
      const difficulty = document.getElementById('difficulty').value;
      const num = parseInt(document.getElementById('num').value || '5');

      const body = { subject: subj, curriculum: curr, topic, difficulty, num_questions: num };

      if (subj === 'Math' && curr === 'GCSE') {
        body.chapter_num = parseInt(chapterSelect.value);
      } else {
        body.chapter_name = chapterSelect.value || "";
        const qtEl = document.getElementById('question_type');
        if (qtEl) body.question_type = qtEl.value || "";
      }

      try {
        const res = await fetch('/generate', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const data = await res.json();
        document.getElementById('result').textContent = JSON.stringify(data, null, 2);

        const oldLink = document.getElementById('download-link');
        if (oldLink) oldLink.remove();
        if (data?.output_file) {
          const downloadLink = document.createElement('a');
          downloadLink.id = 'download-link';
          downloadLink.href = data.output_file;
          downloadLink.download = data.output_file.split('/').pop();
          downloadLink.textContent = "Download Markdown Excel";
          downloadLink.style.display = 'block';
          downloadLink.style.marginTop = '10px';
          resultArea.appendChild(downloadLink);
        }
      } catch (err) {
        console.error("Error generating:", err);
        document.getElementById('result').textContent = "Error generating questions.";
      }
    });

  })();
  </script>
  </body>
</html>
